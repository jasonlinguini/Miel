<script>
(()=>{ // ===== FR/DE + pauses 10s/5s + anecdotes Coco (fix potReady) =====
  const $=id=>document.getElementById(id);
  const cv=$('cv'), X=cv.getContext('2d');
  const scoreEl=$('score'), comboEl=$('combo'), timeEl=$('time');
  const splash=$('splash'), over=$('over'), final=$('final');
  const bPlay=$('play'), bStart=$('start'), bAgain=$('again');
  const infoPause=$('infoPause'), pauseText=$('pauseText'), resumeIn=$('resumeIn');
  const errBox=$('err'), toasts=$('toasts');

  const I18N={ /* --- identique Ã  avant (FR/DE, facts & coco) --- */ 
    fr:{ title:"Attrape-Abeilles BÃ¼rchen ğŸğŸ¯", sub:"Avec David (Coco), apiculteur en Valais â€” partie 30s",
      score:"Score : ", combo:"Combo : ", time:"Temps : ", play:"Jouer", start:"Lancer",
      welcome:"Bienvenue ğŸ§‘â€ğŸŒ¾",
      rules:"Attrape un max dâ€™abeilles en <b>30&nbsp;secondes</b>.<br>Abeille +10 â€¢ Reine +50 â€¢ GuÃªpe âˆ’10. <b>Astuce :</b> double-tap pour calmer.",
      end:"Fin de partie", again:"Rejouer", wasp:"AÃ¯e ! GuÃªpe !", gold:"âœ¨ Miel dorÃ© ! x2",
      pauseTitle:"Minute apicole", resume:"Reprise dans",
      facts:[
        "Une abeille produit ~1/12 de cuillÃ¨re Ã  cafÃ© de miel dans toute sa vie.",
        "Elles dansent pour indiquer la direction dâ€™une fleur â€” la danse frÃ©tillante.",
        "La reine peut pondre ~2 000 Å“ufs par jour. Respect.",
        "La ruche garde ~35 Â°C, hiver comme Ã©tÃ© : climâ€™ naturelle !",
        "Les abeilles voient lâ€™ultraviolet : des panneaux fluo pour elles.",
        "Un pot de 500 g = nectar dâ€™environ 2 millions de fleurs."
      ],
      coco:[
        "Coco a troquÃ© les moutons pour les abeilles : moins de bÃªÃªÃª, plus de bzzz ğŸ‘â†’ğŸ.",
        "Dans le garage : trois motos et une Topolinoâ€¦ qui Â« redÃ©marre cet Ã©tÃ© Â» depuis 8 ans.",
        "A tentÃ© de transporter une rucheâ€¦ en moto. 200 m plus tard : demi-tour.",
        "Son miel prÃ©fÃ©rÃ© ? Celui Â« juste pour goÃ»ter Â» â€” la cuillÃ¨re disparaÃ®t mystiquement.",
        "La pergola Ã  Crans-Montana : chantier lÃ©gendaire. Avant les JO 2028 ?",
        "Coco parle aux abeilles comme Ã  ses anciens moutons. Il jure quâ€™elles rÃ©pondent."
      ]
    },
    de:{ title:"BienenfÃ¤nger BÃ¼rchen ğŸğŸ¯", sub:"Mit David (Coco), Imker im Wallis â€” 30-Sekunden-Runde",
      score:"Punkte: ", combo:"Kombi: ", time:"Zeit: ", play:"Spielen", start:"Start",
      welcome:"Willkommen ğŸ§‘â€ğŸŒ¾",
      rules:"Fange mÃ¶glichst viele Bienen in <b>30&nbsp;Sekunden</b>.<br>Biene +10 â€¢ KÃ¶nigin +50 â€¢ Wespe âˆ’10. <b>Tipp:</b> Doppeltipp beruhigt.",
      end:"Spielende", again:"Nochmal", wasp:"Aua! Wespe!", gold:"âœ¨ Goldhonig! x2",
      pauseTitle:"Imker-Minute", resume:"Weiter in",
      facts:[
        "Eine Biene produziert im Leben etwa 1/12 TeelÃ¶ffel Honig.",
        "Sie â€tanzenâ€œ, um BlÃ¼ten zu zeigen â€“ der SchwÃ¤nzeltanz.",
        "Die KÃ¶nigin legt bis zu ~2 000 Eier pro Tag.",
        "Im Stock herrschen ~35 Â°C â€“ natÃ¼rliche Klimaanlage!",
        "Bienen sehen UV â€“ manche BlÃ¼ten sind Leuchtschilder.",
        "Ein 500-g-Glas = Nektar von rund 2 Millionen BlÃ¼ten."
      ],
      coco:[
        "Coco tauschte Schafe gegen Bienen: weniger MÃ¤h, mehr Bzzz ğŸ‘â†’ğŸ.",
        "In der Garage: drei MotorrÃ¤der und eine Topolinoâ€¦ â€lÃ¤uft im Sommer wiederâ€œ, seit 8 Jahren.",
        "Wollte eine Beute per Motorrad transportieren. Nach 200 m: Plan geÃ¤ndert.",
        "Lieblingshonig? Der zum â€nur kurz probierenâ€œ â€“ LÃ¶ffel bleibt weg.",
        "Pergola in Crans-Montana: epische Baustelle. Vor 2028 fertig?",
        "Coco spricht mit den Bienen wie mit Schafen. Er meint, sie antworten."
      ]
    }
  };

  let LANG=(navigator.language||"fr").startsWith("de")?"de":"fr";
  function setLang(){
    const t=I18N[LANG];
    $("t-title").textContent=t.title; $("t-sub").textContent=t.sub;
    $("t-score").firstChild.nodeValue=t.score; $("t-combo").firstChild.nodeValue=t.combo; $("t-time").firstChild.nodeValue=t.time+" ";
    $("t-play").textContent=t.play; $("t-start").textContent=t.start;
    $("t-welcome").textContent=t.welcome; $("t-rules").innerHTML=t.rules;
    $("t-end").textContent=t.end; $("t-again").textContent=t.again;
    $("t-pause-title").textContent=t.pauseTitle; $("t-resume").textContent=t.resume;
    $("lang-fr").classList.toggle("active",LANG==="fr");
    $("lang-de").classList.toggle("active",LANG==="de");
  }
  $("lang-fr").onclick=()=>{LANG="fr"; setLang(); buildMessagePool();};
  $("lang-de").onclick=()=>{LANG="de"; setLang(); buildMessagePool();};
  setLang();

  // Afficher les erreurs Ã  lâ€™Ã©cran (utile si Ã§a re-bloque)
  window.onerror=(m,s)=>{errBox.style.display='block'; errBox.textContent=(m||'JS Error')+'\n'+(s||'');};

  // Images
  const hive=new Image(); hive.src='719AC91B-EB0C-40B6-88AA-254CEA3F46CD.png';
  let hiveOK=false; hive.onload=()=>{hiveOK=true; layout();}; hive.onerror=layout;

  const potImg=new Image();
  let potReady=false;                 // â† UNE SEULE dÃ©claration
  potImg.src='IMG_7596.png';
  potImg.onload=()=>{potReady=true;};

  // Layout
  let W=1280,H=720,dpr=1;
  let hiveRect={x:0,y:0,w:0,h:0}, mouth={x:0,y:0};
  function layout(){
    dpr=Math.min(devicePixelRatio||1,2);
    W=cv.clientWidth; H=cv.clientHeight;
    cv.width=Math.floor(W*dpr); cv.height=Math.floor(H*dpr);
    X.setTransform(dpr,0,0,dpr,0,0);
    const ratio=hiveOK?hive.naturalWidth/hive.naturalHeight:2.17;
    const w=Math.min(W*0.92, H*0.8*ratio), h=w/ratio;
    hiveRect={x:(W-w)/2,y:(H-h)/2,w:hiveOK?w:0,h:hiveOK?h:0};
    mouth={x:hiveRect.x+hiveRect.w*0.72, y:hiveRect.y+hiveRect.h*0.56};
  }
  addEventListener('resize', layout, {passive:true}); layout();

  // Ã‰tat
  let running=false, pausedInfo=false, timer=30, score=0, mult=1, gold=0, smoke=0, serie=0, serieTTL=0;
  const ptr={x:W/2,y:H/2,last:0}; let pot={x:W/2,y:H/2};
  let ents=[]; const MAX=14;
  let nextPauseAt=20;
  let pool=[], poolIdx=0;
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a;}
  function buildMessagePool(){ const t=I18N[LANG]; pool=shuffle([ ...t.facts.map(x=>"ğŸ“š "+x), ...t.coco.map(x=>"ğŸ˜‚ "+x) ]); poolIdx=0; }
  buildMessagePool();

  // UI helpers
  const toast=(msg)=>{ if(toasts.childElementCount) return; const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toasts.appendChild(d); setTimeout(()=>{d.style.opacity='0'; d.style.transform='translateY(-6px)';},1000); setTimeout(()=>d.remove(),1400); };
  const hud=()=>{scoreEl.textContent=score; comboEl.textContent='x'+mult; timeEl.textContent=Math.ceil(timer);};

  // Inputs
  function setPtr(e){const b=cv.getBoundingClientRect(); if(e.touches?.[0]){ptr.x=e.touches[0].clientX-b.left;ptr.y=e.touches[0].clientY-b.top;} else if(e.clientX!=null){ptr.x=e.clientX-b.left;ptr.y=e.clientY-b.top;}}
  cv.addEventListener('mousemove',setPtr);
  cv.addEventListener('touchmove',setPtr,{passive:true});
  cv.addEventListener('touchstart',e=>{setPtr(e);const n=performance.now(); if(n-ptr.last<300) smoke=Math.max(smoke,6); ptr.last=n;},{passive:true});

  // Physique
  const attract=(ax,ay,bx,by,s)=>{let dx=ax-bx,dy=ay-by,d2=dx*dx+dy*dy; if(d2<1)d2=1; const d=Math.sqrt(d2), f=Math.max(-.08,Math.min(.08,s/d2)); return{fx:(dx/d)*f,fy:(dy/d)*f,d};};
  function spawn(q=false){ const ang=(Math.random()*Math.PI/2)-Math.PI/4, dir={x:0.86,y:0.2}; const cs=Math.cos(ang), sn=Math.sin(ang); const v={x:dir.x*cs-dir.y*sn, y:dir.x*sn+dir.y*cs}; const sp=1.2+Math.random()*0.8; ents.push({t:q?'Q':'B',x:mouth.x+(Math.random()*6-3),y:mouth.y+(Math.random()*6-3),vx:v.x*sp,vy:v.y*sp,r:q?13:10,spd:sp,sw:Math.random()*6.28}); }
  function spawnWasp(){ ents.push({t:'W',x:Math.random()*W,y:Math.random()*H,vx:0,vy:0,r:12,spd:1.2,sw:Math.random()*6.28,cd:0}); }

  function reset(){
    score=0; mult=1; timer=30; gold=0; smoke=0; serie=0; serieTTL=0; ents.length=0;
    for(let i=0;i<MAX;i++) spawn(Math.random()<.12); spawnWasp();
    pot={x:W/2,y:H/2}; hud(); nextPauseAt=20; pausedInfo=false; buildMessagePool();
  }

  // Rendu
  function drawHive(){ if(!hiveOK) return; X.fillStyle="rgba(0,0,0,.15)"; X.fillRect(hiveRect.x-8,hiveRect.y-8,hiveRect.w+16,hiveRect.h+16); X.drawImage(hive, hiveRect.x, hiveRect.y, hiveRect.w, hiveRect.h); X.globalAlpha=.33; X.fillStyle='rgba(215,176,106,.7)'; X.beginPath(); X.arc(mouth.x,mouth.y,7,0,6.283); X.fill(); X.globalAlpha=1; }
  function drawPot(){ const pw=Math.min(140, Math.max(110, Math.min(W,H)*0.2)), ph=pw*1.25; const sh=ph*0.13; const g=X.createRadialGradient(pot.x,pot.y+ph*0.45,4,pot.x,pot.y+ph*0.45,pw*0.55); g.addColorStop(0,'rgba(0,0,0,.35)'); g.addColorStop(1,'rgba(0,0,0,0)'); X.fillStyle=g; X.beginPath(); X.ellipse(pot.x,pot.y+ph*0.45,pw*0.52,sh,0,0,Math.PI*2); X.fill(); if(potReady) X.drawImage(potImg, pot.x-pw/2, pot.y-ph/2, pw, ph); }
  function drawBee(b){ X.save(); X.translate(b.x,b.y); X.rotate(Math.atan2(b.vy,b.vx)); X.fillStyle=(b.t==='Q')?'#ffe08f':'#e7c16a'; X.beginPath(); X.ellipse(0,0,b.r+2,b.r,0,0,6.283); X.fill(); X.lineWidth=2; X.strokeStyle='#2b2418'; X.beginPath(); X.moveTo(-b.r,-2); X.lineTo(b.r,-2); X.moveTo(-b.r,2); X.lineTo(b.r,2); X.stroke(); X.restore(); }
  function drawWasp(w){ X.save(); X.translate(w.x,w.y); X.rotate(Math.atan2(w.vy,w.vx)); X.fillStyle='#ff7d7d'; X.beginPath(); X.ellipse(0,0,w.r+2,w.r,0,0,6.283); X.fill(); X.restore(); }

  function step(dt){
    if(!running || pausedInfo) return;
    const ez=Math.min(1,dt*7); pot.x+=(ptr.x-pot.x)*ez; pot.y+=(ptr.y-pot.y)*ez;

    const press=1+(1-timer/30)*0.8; if(ents.length<MAX*press) spawn(Math.random()<.15);
    const FORCE=3400*press;

    for(let i=ents.length-1;i>=0;i--){
      const e=ents[i]; e.sw+=dt*(.5+Math.random()*.7); e.vx+=Math.cos(e.sw)*.05; e.vy+=Math.sin(e.sw)*.05;
      if(e.t!=='W'){
        const sl=smoke>0?.6:1; const a=attract(pot.x,pot.y,e.x,e.y,FORCE*sl);
        e.vx+=a.fx; e.vy+=a.fy; const cap=2.3*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy;
        if(a.d<80){ score+=(e.t==='Q'?50:10)*mult; serie++; serieTTL=3; if(serie%3===0){gold=6; mult=2; toast(I18N[LANG].gold);} ents.splice(i,1); continue; }
      } else {
        const sl=smoke>0?.55:1; const a=attract(e.x,e.y,pot.x,pot.y,3100*sl);
        e.vx+=a.fx; e.vy+=a.fy; const cap=2.5*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy; if(e.cd>0) e.cd-=dt;
        if(e.cd<=0 && Math.hypot(e.x-pot.x,e.y-pot.y)<56){ score=Math.max(0,score-10); serie=0; serieTTL=0; mult=gold>0?2:1; e.cd=.9; toast(I18N[LANG].wasp); }
      }
      if(e.x<-20)e.x=W+20; if(e.x>W+20)e.x=-20; if(e.y<-20)e.y=H+20; if(e.y>H+20)e.y=-20;
    }

    if(serieTTL>0){serieTTL-=dt; if(serieTTL<=0) serie=0;}
    if(gold>0){gold-=dt; if(gold<=0) mult=1;}
    if(smoke>0) smoke-=dt;

    const before=Math.ceil(timer);
    timer-=dt;
    const after=Math.ceil(timer);
    if(after!==before && after===nextPauseAt && after>0) triggerInfoPause();
    if(timer<=0){ end(); return; }
    hud();
  }

  function triggerInfoPause(){
    pausedInfo=true;
    const t=I18N[LANG];
    const msg = pool[poolIdx++ % pool.length] || (LANG==="fr"?"(petite pause)":"(kurze Pause)");
    $("t-pause-title").textContent=t.pauseTitle; $("t-resume").textContent=t.resume; pauseText.textContent=msg;
    let left=5; resumeIn.textContent=left; infoPause.style.display='grid';
    const int=setInterval(()=>{ left--; resumeIn.textContent=left; if(left<=0){clearInterval(int); infoPause.style.display='none'; pausedInfo=false;} },1000);
    nextPauseAt-=10;
  }

  function render(){
    X.clearRect(0,0,W,H);
    X.globalAlpha=.1; X.strokeStyle='#261d14';
    for(let i=0;i<W;i+=64){X.beginPath();X.moveTo(i,0);X.lineTo(i,H);X.stroke();}
    for(let j=0;j<H;j+=64){X.beginPath();X.moveTo(0,j);X.lineTo(W,j);X.stroke();}
    X.globalAlpha=1;
    drawHive();
    for(const e of ents){ (e.t==='W')?drawWasp(e):drawBee(e); }
    drawPot();
  }

  function loop(t){ const dt=Math.min(.033,(t-(loop.t||t))/1000); loop.t=t; step(dt); render(); requestAnimationFrame(loop); }

  function start(){ reset(); running=true; splash.style.display='none'; over.style.display='none'; loop.t=undefined; requestAnimationFrame(loop); }
  function end(){ running=false; over.style.display='grid';
    final.textContent=(LANG==="fr")?`Score : ${score} â€¢ ${mult===2?'miel dorÃ© activÃ©':'combo x1'}`:`Punkte: ${score} â€¢ ${mult===2?'Goldhonig aktiv':'Kombi x1'}`; }

  bPlay.addEventListener('click', start);
  bStart.addEventListener('click', start);
  bAgain.addEventListener('click', start);

  function hud(){ scoreEl.textContent=score; comboEl.textContent='x'+mult; timeEl.textContent=Math.ceil(timer); }

  layout(); hud();
})();
</script>
