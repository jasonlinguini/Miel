<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Attrape-Abeilles Bürchen 🐝🍯 – version stable</title>
<style>
  :root{--gold:#c69a57;--ink:#111;--bg:#0d0a08;--panel:#131313;--line:#2b2b2b}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-rows:auto auto auto 1fr auto;min-height:100dvh}
  header{display:flex;gap:12px;align-items:center;padding:max(10px,env(safe-area-inset-top)) 14px 10px;background:#111;border-bottom:1px solid var(--line)}
  .label{width:56px;height:56px;border-radius:10px;border:1px solid #6c512c;object-fit:cover}
  .title h1{margin:0 0 2px 0;font-size:clamp(18px,4.6vw,28px)}
  .title p{margin:0;color:#cbb48b}
  .avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;border:1px solid #3a2d1a}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .fact{padding:8px 14px;background:#151515;border-top:1px solid var(--line);border-bottom:1px solid var(--line);color:#e7d6b8;font-size:14px}
  .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px;background:#101010;border-bottom:1px solid var(--line)}
  .pill{background:#1a1a1a;border:1px solid #3a2d1a;border-radius:999px;padding:7px 12px;font-weight:700}
  .btn{cursor:pointer;background:var(--gold);color:var(--ink);border:none;border-radius:12px;padding:10px 14px;font-weight:800}
  .btn.alt{background:#1a1a1a;color:#fff;border:1px solid #3a2d1a}
  .canvasWrap{position:relative;width:100%;height:calc(100dvh - 300px);min-height:340px;touch-action:none}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:radial-gradient(1200px 600px at 20% 20%,#1a1410,#0d0a08 60%)}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45)}
  .card{background:var(--panel);border:1px solid #3a2d1a;border-radius:16px;padding:18px;max-width:720px}
  .toasts{position:fixed;left:0;right:0;bottom:12px;display:grid;place-items:center;pointer-events:none}
  .toast{background:#222;border:1px solid #3a2d1a;border-radius:12px;padding:10px 14px;box-shadow:0 8px 30px rgba(0,0,0,.4)}
  footer{padding:10px 14px env(safe-area-inset-bottom);color:#cbb48b;font-size:13px;border-top:1px solid var(--line)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img class="label" src="4A20A11D-FFE4-40F0-B5C8-41535E58C891.jpeg" alt="Étiquette Bürchen">
    <div class="title">
      <h1>Attrape-Abeilles <span style="color:#c69a57">Bürchen</span> 🐝🍯</h1>
      <p>Avec David, apiculteur en Valais. (version stable mobile)</p>
    </div>
    <div class="avatar"><img src="999BE385-AE83-4F5F-8B9E-D1371F104F83.jpeg" alt="David"></div>
  </header>

  <div class="fact" id="fact">Conseil : double-tap pour envoyer un peu de fumée calmante 💨.</div>

  <div class="hud">
    <div class="pill">Score : <span id="score">0</span></div>
    <div class="pill">Multiplicateur : <span id="multi">x1</span></div>
    <div class="pill">Temps : <span id="time">90</span>s</div>
    <button class="btn" id="play">▶️ Jouer</button>
    <button class="btn alt" id="pause">⏸️ Pause</button>
    <button class="btn" id="smoke">💨 Fumée</button>
  </div>

  <div class="canvasWrap">
    <canvas id="game"></canvas>

    <!-- Ecran d’accueil -->
    <div class="overlay" id="splash">
      <div class="card">
        <h2>Bienvenue 🧑‍🌾</h2>
        <p>Attrape les abeilles avec le pot de miel artisanal <b>Bürchen</b>.<br>
        <small>Simple, fluide, quelques surprises… et des infos utiles 🧠.</small></p>
        <ul style="text-align:left;max-width:640px;margin:10px auto;line-height:1.6">
          <li>Glisse le doigt (ou la souris) : le pot suit.</li>
          <li>Abeille = +10 • Reine = +50 • Guêpe = −10 (il n’y en a qu’<i>une</i> et elle est lente).</li>
          <li>3 captures d’affilée ⇒ <b>miel doré</b> (points x2, 8s).</li>
          <li>💨 Fumée ou double-tap pour calmer tout le monde 6s.</li>
        </ul>
        <button class="btn" id="startA">🍯 Commencer</button>
      </div>
    </div>

    <!-- Fin de partie -->
    <div class="overlay" id="gameover" style="display:none">
      <div class="card">
        <h2>Fin de partie</h2>
        <p id="final"></p>
        <div id="quiz" style="margin-top:12px;display:none">
          <h3>Quiz éclair 🐝 (+50 pts / +10s si juste)</h3>
          <p id="qtext"></p>
          <div id="qopts"></div>
          <p id="qexp" style="display:none;color:#e7d6b8;margin-top:8px"></p>
        </div>
        <button class="btn" id="restart">🔁 Rejouer</button>
      </div>
    </div>
  </div>

  <footer>Étiquette Bürchen & photo de David © toi. Code : version “solide” – aucune dépendance externe.</footer>
</div>
<div class="toasts" id="toasts"></div>

<script>
(() => {
  // ---------- Sélecteurs ----------
  const $ = (id)=>document.getElementById(id);
  const canvas = $('game'), ctx = canvas.getContext('2d');
  const splash = $('splash'), over = $('gameover');
  const scoreEl=$('score'), multiEl=$('multi'), timeEl=$('time'), factEl=$('fact');
  const btnPlay=$('play'), btnPause=$('pause'), btnSmoke=$('smoke'), btnStart=$('startA'), btnRestart=$('restart');
  const toasts=$('toasts');

  // ---------- Layout ----------
  let W=1280,H=720;
  function resize(){
    const dpr=Math.min(devicePixelRatio||1,2);
    W=canvas.clientWidth; H=canvas.clientHeight;
    canvas.width = Math.floor(W*dpr); canvas.height = Math.floor(H*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize, {passive:true}); resize();

  // ---------- Etat ----------
  let running=false, paused=false, t0=0, timer=90, score=0, mult=1;
  let goldenLeft=0, smokeLeft=0, serie=0, serieTTL=0;
  const ptr={x:W/2,y:H/2,lastTap:0};
  let ents=[], pot={x:W/2,y:H/2};
  const MAX_BEES=10, ONE_WASP=true;

  // ---------- Data EDU ----------
  const FACTS=[
    "Une abeille visite ~50 fleurs par trajet 🌸",
    "La fumée masque l’alarme : elles se calment et se gavent de miel.",
    "80% des plantes à fleurs dépendent des pollinisateurs.",
    "La reine peut pondre jusqu’à 2'000 œufs/jour 👑",
    "Planter des fleurs locales aide vraiment les colonies."
  ];
  const QUIZ=[
    {q:"Pourquoi l’apiculteur utilise-t-il la fumée ?",
     a:["Pour calmer les abeilles","Pour les faire danser","Pour cuire des crêpes"],
     ok:0, exp:"La fumée masque les phéromones d’alarme et pousse les abeilles à se gaver de miel."},
    {q:"Qui pique le plus souvent ?",
     a:["Les ouvrières","La reine","Le faux-bourdon"], ok:0, exp:"La reine pique rarement; le mâle n’a pas de dard."}
  ];
  let factIdx=0, nextFactAt=6;

  // ---------- Utilitaires ----------
  function toast(msg){
    if(toasts.childElementCount>=1) return; // anti-spam
    const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toasts.appendChild(d);
    setTimeout(()=>{d.style.opacity='0'; d.style.transform='translateY(-6px)'}, 1100);
    setTimeout(()=>d.remove(), 1500);
  }
  function hud(){ scoreEl.textContent=score; multiEl.textContent="x"+mult; timeEl.textContent=Math.ceil(timer); }

  // ---------- Spawns ----------
  function spawnBee(queen=false){
    const side=Math.floor(Math.random()*4), m=28;
    ents.push({t:queen?'Q':'B',
      x: side==0?-m : side==1?W+m : Math.random()*W,
      y: side==2?-m : side==3?H+m : Math.random()*H,
      vx:0,vy:0,r:queen?13:10,spd:0.9+(Math.random()*0.6),sw:Math.random()*6.28});
  }
  function spawnWasp(){
    ents.push({t:'W',x:Math.random()*W,y:Math.random()*H,vx:0,vy:0,r:12,spd:1.1,sw:Math.random()*6.28,cd:0});
  }

  function reset(){
    score=0; timer=90; mult=1; goldenLeft=0; smokeLeft=0; serie=0; serieTTL=0;
    ents.length=0;
    for(let i=0;i<MAX_BEES;i++) spawnBee(Math.random()<.12);
    if(ONE_WASP) spawnWasp();
    pot.x=W/2; pot.y=H/2;
    hud(); nextFactAt=6; factEl.textContent = "Conseil : double-tap pour envoyer un peu de fumée calmante 💨.";
  }

  // ---------- Entrées ----------
  function setPtr(e){
    const b=canvas.getBoundingClientRect();
    if(e.touches?.[0]){ ptr.x=e.touches[0].clientX-b.left; ptr.y=e.touches[0].clientY-b.top; }
    else if(e.clientX!=null){ ptr.x=e.clientX-b.left; ptr.y=e.clientY-b.top; }
  }
  canvas.addEventListener('mousemove', setPtr);
  canvas.addEventListener('touchstart', (e)=>{ setPtr(e); const n=performance.now();
    if(n-ptr.lastTap<300) smokeLeft=Math.max(smokeLeft,6); ptr.lastTap=n; }, {passive:true});
  canvas.addEventListener('touchmove', setPtr, {passive:true});

  // ---------- Physique ----------
  function attract(ax,ay,bx,by,str){
    let dx=ax-bx, dy=ay-by, d2=dx*dx+dy*dy; if(d2<1) d2=1;
    const d=Math.sqrt(d2), f=Math.max(-.08, Math.min(.08, str/d2));
    return {fx:(dx/d)*f, fy:(dy/d)*f, d};
  }

  // ---------- Rendu ----------
  function grid(){
    ctx.globalAlpha=.25;
    for(let i=0;i<W;i+=64){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,H); ctx.strokeStyle='#251d14'; ctx.stroke(); }
    for(let j=0;j<H;j+=64){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(W,j); ctx.strokeStyle='#251d14'; ctx.stroke(); }
    ctx.globalAlpha=1;
  }
  function drawJar(){
    const r=60; ctx.save(); ctx.translate(pot.x,pot.y);
    ctx.beginPath(); ctx.moveTo(-r*.6,-r*.6);
    ctx.quadraticCurveTo(-r*.9,r*.2,-r*.5,r*.9);
    ctx.quadraticCurveTo(0,r*1.2,r*.5,r*.9);
    ctx.quadraticCurveTo(r*.9,r*.2,r*.6,-r*.6); ctx.closePath();
    ctx.fillStyle='#2b2116'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#6c512c'; ctx.stroke();
    // étiquette
    const img=new Image(); img.src="4A20A11D-FFE4-40F0-B5C8-41535E58C891.jpeg";
    ctx.drawImage(img,-43,-56,86,112);
    // miel
    ctx.globalAlpha=.45; ctx.beginPath(); ctx.arc(0,10,70,0,Math.PI*2);
    ctx.fillStyle=goldenLeft>0?'#ffd777':'#c69a57'; ctx.fill(); ctx.globalAlpha=1; ctx.restore();
  }
  function drawBee(b){
    ctx.save(); ctx.translate(b.x,b.y); ctx.beginPath();
    ctx.fillStyle=b.t=='Q'?'#ffd777':'#e6c15e';
    ctx.ellipse(0,0,b.r+2,b.r,0,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle='#2b2116';
    ctx.beginPath(); ctx.moveTo(-b.r,-2); ctx.lineTo(b.r,-2); ctx.moveTo(-b.r,2); ctx.lineTo(b.r,2); ctx.stroke();
    ctx.restore();
  }
  function drawWasp(w){ ctx.save(); ctx.translate(w.x,w.y); ctx.beginPath(); ctx.fillStyle='#ff6969';
    ctx.ellipse(0,0,w.r+2,w.r,0,0,Math.PI*2); ctx.fill(); ctx.restore(); }

  // ---------- Boucle ----------
  function step(dt){
    // facts
    nextFactAt -= dt;
    if(nextFactAt<=0){
      factEl.textContent = "ℹ️ " + FACTS[factIdx++ % FACTS.length];
      nextFactAt = 9;
    }

    // suivre le doigt
    const ez=Math.min(1, dt*6); pot.x += (ptr.x-pot.x)*ez; pot.y += (ptr.y-pot.y)*ez;

    const AS = 3300; // force d’attraction (facile)
    for(let i=ents.length-1;i>=0;i--){
      const e=ents[i];
      e.sw += dt*(.4+Math.random()*.6); e.vx += Math.cos(e.sw)*.04; e.vy += Math.sin(e.sw)*.04;

      if(e.t!=='W'){ // abeille / reine
        const sl=smokeLeft>0?.65:1;
        const {fx,fy,d} = attract(pot.x,pot.y,e.x,e.y,AS*sl);
        e.vx+=fx; e.vy+=fy;
        const cap=2.0*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy;
        if(d<85){ // capture
          score += (e.t==='Q'?50:10)*mult;
          serie++; serieTTL=3;
          if(serie%3===0){ goldenLeft=8; mult=2; toast("✨ Miel doré : points x2 !"); }
          ents.splice(i,1);
          if(Math.random()<.1) spawnBee(true); // petite chance de reine
          else spawnBee(false);
          continue;
        }
      } else {     // guêpe
        const sl=smokeLeft>0?.55:1;
        const {fx,fy} = attract(e.x,e.y,pot.x,pot.y,3000*sl);
        e.vx+=fx; e.vy+=fy;
        const cap=2.2*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy;
        if(e.cd>0) e.cd-=dt;
        if(e.cd<=0 && Math.hypot(e.x-pot.x,e.y-pot.y)<58){
          score=Math.max(0,score-10); serie=0; serieTTL=0; mult= goldenLeft>0?2:1; e.cd=0.9; // cooldown
          toast("Aïe ! Guêpe un peu susceptible 🐝");
        }
      }

      // wrap
      if(e.x<-20) e.x=W+20; if(e.x>W+20) e.x=-20;
      if(e.y<-20) e.y=H+20; if(e.y>H+20) e.y=-20;
    }

    // timers
    if(serieTTL>0){ serieTTL-=dt; if(serieTTL<=0) serie=0; }
    if(goldenLeft>0){ goldenLeft-=dt; if(goldenLeft<=0){ mult=1; } }
    if(smokeLeft>0) smokeLeft-=dt;

    timer-=dt; if(timer<=0){ endGame(); return; }
    hud();
  }

  function render(){
    ctx.clearRect(0,0,W,H); grid();
    for(const e of ents){ (e.t==='W')?drawWasp(e):drawBee(e); }
    drawJar();
  }

  function loop(t){
    if(!running) return;
    if(!paused){
      const dt = Math.min(.033, (t - t0)/1000); t0=t;
      step(dt); render();
    }
    requestAnimationFrame(loop);
  }

  // ---------- Contrôles ----------
  function start(){
    reset(); running=true; paused=false; splash.style.display="none"; over.style.display="none";
    t0=performance.now(); requestAnimationFrame(loop);
  }
  function pauseToggle(){
    if(!running) return;
    paused=!paused; btnPause.textContent = paused? "▶️ Reprendre" : "⏸️ Pause";
  }
  function endGame(){
    running=false; over.style.display="grid";
    $('final').textContent = `Score : ${score}  •  Multiplicateur max : x${mult}`;
    // petit quiz (non bloquant si on ferme trop vite)
    miniQuiz();
  }

  // ---------- Mini-quiz (à la fin) ----------
  function miniQuiz(){
    const q = QUIZ[Math.floor(Math.random()*QUIZ.length)];
    const qtext = $('qtext'), qopts=$('qopts'), qexp=$('qexp');
    qtext.textContent=q.q; qexp.style.display='none'; qexp.textContent=q.exp;
    qopts.innerHTML="";
    q.a.forEach((txt,i)=>{
      const b=document.createElement('button');
      b.className='btn alt'; b.style.display='block'; b.style.margin='6px 0';
      b.textContent=txt; b.onclick=()=>{
        [...qopts.children].forEach(ch=>ch.disabled=true);
        if(i===q.ok){ score+=50; timer+=10; toast("✅ +50 pts, +10s"); }
        else { toast("❌ Pas grave !"); }
        qexp.style.display='block';
      };
      qopts.appendChild(b);
    });
    $('quiz').style.display='block';
  }

  // ---------- Événements UI ----------
  btnPlay.onclick=start; btnStart.onclick=start; btnRestart.onclick=start;
  btnPause.onclick=pauseToggle;
  btnSmoke.onclick=()=>{ smokeLeft=Math.max(smokeLeft,6); toast("💨 “Tout doux les copines.” — David"); };

  // démarrer au premier tap n’importe où (pratique sur mobile)
  let armed=true; window.addEventListener('pointerdown',()=>{ if(armed){ armed=false; start(); } }, {once:true, passive:true});

  // init
  splash.style.display="grid"; over.style.display="none"; hud();
})();
</script>
</body>
</html>
