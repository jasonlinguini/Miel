<script>
(()=>{ /* ===== Int√©gration ruche r√©aliste + 30s ===== */
const $=id=>document.getElementById(id);
const C=$('game'), X=C.getContext('2d');
const splash=$('splash'), over=$('gameover');
const scoreEl=$('score'), multiEl=$('multi'), bar=$('bar'), factEl=$('fact');
const bPlay=$('play'), bStart=$('startA'), bRestart=$('restart'), bSmoke=$('smoke');
const toasts=document.getElementById('toasts');

window.onerror=(m)=>{console.error(m)};

const hive=new Image(); hive.src='719AC91B-EB0C-40B6-88AA-254CEA3F46CD.png';
const labelImg=document.getElementById('labelImg');

let W=1280,H=720,dpr=1, hReady=false;
let hiveRect={x:0,y:0,w:0,h:0};
let mouth={x:0,y:0}, cfg={px:.72, py:.56};                // % sur l‚Äôimage (trou de vol)
try{ const s=localStorage.getItem('mouthCfg'); if(s) cfg=JSON.parse(s);}catch{}
let boardDir={x:0.86,y:0.20};                              // direction planche d‚Äôenvol (approx.)

hive.onload=()=>{hReady=true; resize();};
function resize(){
  dpr=Math.min(devicePixelRatio||1,2);
  W=C.clientWidth; H=C.clientHeight;
  C.width=Math.floor(W*dpr); C.height=Math.floor(H*dpr);
  X.setTransform(dpr,0,0,dpr,0,0);
  const ratio = hReady ? hive.naturalWidth/hive.naturalHeight : 2.17;
  let w=Math.min(W*0.82, H*0.70*ratio), h=w/ratio;
  hiveRect={x:(W-w)/2,y:(H-h)/2,w,h};
  mouth={x:hiveRect.x+hiveRect.w*cfg.px, y:hiveRect.y+hiveRect.h*cfg.py};
}
addEventListener('resize', resize, {passive:true}); resize();

/* ---- Jeu ---- */
let running=false, paused=false, timer=30, score=0, mult=1;
let goldLeft=0, smokeLeft=0, serie=0, serieTTL=0, vibe=0;
const ptr={x:W/2,y:H/2,lastTap:0}; let ents=[], pot={x:W/2,y:H/2}; const MAX=14;

const FACTS=[
 "La fum√©e masque l‚Äôalarme : elles se calment et se gavent de miel.",
 "Une abeille visite ~50 fleurs par trajet üå∏",
 "80% des plantes √† fleurs d√©pendent des pollinisateurs.",
 "La reine peut pondre jusqu‚Äô√† 2'000 ≈ìufs/jour üëë",
 "Plante des fleurs locales : nectar r√©gulier !"
];
let fi=0, nextTip=6;

function toast(m){ if(toasts.childElementCount) return;
  const d=document.createElement('div'); d.className='toast'; d.textContent=m; toasts.appendChild(d);
  setTimeout(()=>{d.style.opacity='0'; d.style.transform='translateY(-6px)';},1000);
  setTimeout(()=>d.remove(),1400);
}
function hud(){ scoreEl.textContent=score; multiEl.textContent='x'+mult; bar.setAttribute('stroke-dashoffset',(1-timer/30)*176); }

/* Particules ambiance */
const pollen=Array.from({length:38},()=>({x:Math.random()*W,y:Math.random()*H,s:1+Math.random()*2,sp:.2+.6*Math.random()}));

/* Spawns : abeilles derri√®re la fa√ßade au d√©part */
function spawn(queen=false){
  const ang=(Math.random()*Math.PI/2) - Math.PI/4; // c√¥ne vers l‚Äôavant
  const speed=1.3+(Math.random()*0.7);
  const dir={x:boardDir.x*Math.cos(ang)-boardDir.y*Math.sin(ang),
             y:boardDir.x*Math.sin(ang)+boardDir.y*Math.cos(ang)};
  ents.push({
    t:queen?'Q':'B', stage:'emerge', age:0,
    x: mouth.x + (Math.random()*6-3), y: mouth.y + (Math.random()*6-3),
    vx: dir.x*speed, vy: dir.y*speed,
    r: queen?13:10, spd: speed, sw: Math.random()*6.28
  });
}
function spawnWasp(){ ents.push({t:'W',stage:'fly',age:1,x:Math.random()*W,y:Math.random()*H,vx:0,vy:0,r:12,spd:1.2,sw:Math.random()*6.28,cd:0}); }

function reset(){
  score=0; mult=1; timer=30; goldLeft=0; smokeLeft=0; serie=0; serieTTL=0; vibe=0;
  ents.length=0; for(let i=0;i<MAX;i++) spawn(Math.random()<.12); spawnWasp();
  pot.x=W/2; pot.y=H/2; hud(); nextTip=6;
}

/* Inputs + calibration longue pression */
function setPtr(e){const b=C.getBoundingClientRect();
  if(e.touches?.[0]){ptr.x=e.touches[0].clientX-b.left; ptr.y=e.touches[0].clientY-b.top;}
  else if(e.clientX!=null){ptr.x=e.clientX-b.left; ptr.y=e.clientY-b.top;}
}
C.addEventListener('mousemove', setPtr);
C.addEventListener('touchmove', setPtr, {passive:true});
C.addEventListener('touchstart', e=>{
  setPtr(e);
  const now=performance.now();
  if(now-ptr.lastTap<300){ smokeLeft=Math.max(smokeLeft,6); }
  ptr.lastTap=now;
  // long press => calibration
  calibTimer=setTimeout(()=>{calibrating=true;}, 700);
},{passive:true});
C.addEventListener('touchend', ()=>clearTimeout(calibTimer));

let calibrating=false, calibTimer=null;
C.addEventListener('pointerdown', e=>{
  if(calibrating){
    const b=C.getBoundingClientRect();
    const x=e.clientX-b.left, y=e.clientY-b.top;
    cfg.px=(x-hiveRect.x)/hiveRect.w; cfg.py=(y-hiveRect.y)/hiveRect.h;
    mouth={x,y};
    try{localStorage.setItem('mouthCfg', JSON.stringify(cfg));}catch{}
    calibrating=false; toast('‚úÖ Trou de vol enregistr√©');
  }
});

/* Physique */
function attract(ax,ay,bx,by,str){let dx=ax-bx,dy=ay-by,d2=dx*dx+dy*dy; if(d2<1)d2=1; const d=Math.sqrt(d2), f=Math.max(-.08,Math.min(.08,str/d2)); return {fx:(dx/d)*f, fy:(dy/d)*f, d};}

/* Rendu couches : 1) arri√®re-plan+pollen 2) abeilles derri√®re 3) ruche 4) abeilles devant 5) pot */
function drawBG(){
  // pollen
  X.save(); X.globalAlpha=.25; X.fillStyle='#ffdd9a';
  pollen.forEach(p=>{p.y+=p.sp*(.5+Math.sin(p.x*.01)*.3); if(p.y>H+4)p.y=-4; X.beginPath(); X.arc(p.x,p.y,p.s,0,6.283); X.fill();});
  X.restore();
}
function drawHive(){
  if(!hReady) return;
  X.save();
  if(vibe>0){ const v=vibe/8; X.translate((Math.random()-.5)*v,(Math.random()-.5)*v); vibe-=.6; }
  X.fillStyle='rgba(0,0,0,.15)'; X.fillRect(hiveRect.x-8,hiveRect.y-8,hiveRect.w+16,hiveRect.h+16);
  X.drawImage(hive, hiveRect.x, hiveRect.y, hiveRect.w, hiveRect.h);
  // lueur or sur le trou
  X.globalAlpha=.33; X.fillStyle='rgba(215,176,106,.7)'; X.beginPath(); X.arc(mouth.x,mouth.y,7,0,6.283); X.fill(); X.globalAlpha=1;
  X.restore();
}
function shadowAt(x,y){ // ombre sur la planche (direction depuis le trou)
  const sx=x+boardDir.x*14, sy=y+boardDir.y*14;
  const g=X.createRadialGradient(sx,sy,2,sx,sy,18); g.addColorStop(0,'rgba(0,0,0,.25)'); g.addColorStop(1,'rgba(0,0,0,0)');
  X.fillStyle=g; X.beginPath(); X.arc(sx,sy,18,0,6.283); X.fill();
}
function drawBee(b){
  shadowAt(b.x,b.y);
  X.save(); X.translate(b.x,b.y); X.rotate(Math.atan2(b.vy,b.vx));
  X.globalAlpha=.6; X.fillStyle='rgba(255,255,255,.7)';
  X.beginPath(); X.ellipse(0,-b.r, b.r*.9, b.r*.55, 0, 0, 6.283); X.fill();
  X.beginPath(); X.ellipse(0, b.r, b.r*.9, b.r*.55, 0, 0, 6.283); X.fill(); X.globalAlpha=1;
  X.fillStyle=(b.t==='Q')?'#ffe08f':'#e7c16a';
  X.beginPath(); X.ellipse(0,0,b.r+2,b.r,0,0,6.283); X.fill();
  X.lineWidth=2; X.strokeStyle='#2b2418';
  X.beginPath(); X.moveTo(-b.r,-2); X.lineTo(b.r,-2); X.moveTo(-b.r,2); X.lineTo(b.r,2); X.stroke();
  X.restore();
}
function drawWasp(w){
  shadowAt(w.x,w.y);
  X.save(); X.translate(w.x,w.y); X.rotate(Math.atan2(w.vy,w.vx));
  X.fillStyle='#ff7d7d'; X.beginPath(); X.ellipse(0,0,w.r+2,w.r,0,0,6.283); X.fill(); X.restore();
}
function drawPot(){
  const r=58; X.save(); X.translate(pot.x,pot.y);
  X.beginPath(); X.moveTo(-r*.6,-r*.6); X.quadraticCurveTo(-r*.9,r*.2,-r*.5,r*.9);
  X.quadraticCurveTo(0,r*1.2,r*.5,r*.9); X.quadraticCurveTo(r*.9,r*.2,r*.6,-r*.6); X.closePath();
  X.fillStyle='#2a2118'; X.fill(); X.lineWidth=2; X.strokeStyle='rgba(215,176,106,.65)'; X.stroke();
  X.drawImage(labelImg,-42,-54,84,108);
  X.globalAlpha=.45; X.beginPath(); X.arc(0,10,68,0,6.283); X.fillStyle=goldLeft>0?'#ffe08f':'#d7b06a'; X.fill(); X.globalAlpha=1; X.restore();
}

/* Boucle */
function step(dt){
  // conseils
  nextTip-=dt; if(nextTip<=0){ factEl.textContent='‚ÑπÔ∏è '+FACTS[fi++%FACTS.length]; nextTip=7; }
  // pot suit
  const ez=Math.min(1,dt*7); pot.x+=(ptr.x-pot.x)*ez; pot.y+=(ptr.y-pot.y)*ez;
  // densit√© croissante
  const press=1+(1-timer/30)*0.8; if(ents.length<MAX*press) spawn(Math.random()<.15);

  const FORCE=3400*press;
  for(let i=ents.length-1;i>=0;i--){
    const e=ents[i]; e.age+=dt; e.sw+=dt*(.5+Math.random()*.7); e.vx+=Math.cos(e.sw)*.05; e.vy+=Math.sin(e.sw)*.05;

    if(e.t!=='W'){
      // attraction
      const sl=smokeLeft>0?.6:1; const {fx,fy,d}=attract(pot.x,pot.y,e.x,e.y,FORCE*sl);
      e.vx+=fx; e.vy+=fy; const cap=2.3*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
      e.x+=e.vx; e.y+=e.vy;
      if(e.stage==='emerge' && e.age>0.22) e.stage='fly';
      if(d<80){ score+=(e.t==='Q'?50:10)*mult; serie++; serieTTL=3; vibe=6; if(navigator.vibrate) navigator.vibrate(20);
        if(serie%3===0){goldLeft=6; mult=2; toast('‚ú® Miel dor√© ! x2');}
        ents.splice(i,1); continue; }
    }else{
      const sl=smokeLeft>0?.55:1; const {fx,fy}=attract(e.x,e.y,pot.x,pot.y,3100*sl);
      e.vx+=fx; e.vy+=fy; const cap=2.5*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
      e.x+=e.vx; e.y+=e.vy; if(e.cd>0) e.cd-=dt;
      if(e.cd<=0 && Math.hypot(e.x-pot.x,e.y-pot.y)<56){ score=Math.max(0,score-10); serie=0; serieTTL=0; mult=goldLeft>0?2:1; e.cd=.9; toast('A√Øe ! Gu√™pe un peu susceptible üêù'); }
    }
    if(e.x<-20)e.x=W+20; if(e.x>W+20)e.x=-20; if(e.y<-20)e.y=H+20; if(e.y>H+20)e.y=-20;
  }

  if(serieTTL>0){ serieTTL-=dt; if(serieTTL<=0) serie=0; }
  if(goldLeft>0){ goldLeft-=dt; if(goldLeft<=0) mult=1; }
  if(smokeLeft>0) smokeLeft-=dt;

  timer-=dt; if(timer<=0){ end(); return; }
  hud();
}

function render(){
  X.clearRect(0,0,W,H);
  // couche fond
  drawBG();
  // abeilles derri√®re (stage emerge)
  for(const e of ents) if(e.t!=='W' && e.stage==='emerge') drawBee(e);
  // ruche
  drawHive();
  // abeilles devant + gu√™pe
  for(const e of ents) if(!(e.t!=='W' && e.stage==='emerge')) (e.t==='W'?drawWasp:drawBee)(e);
  // pot
  drawPot();
  // croix de calibration
  if(calibrating){
    X.save(); X.strokeStyle='rgba(255,220,150,.9)'; X.setLineDash([6,6]); X.lineWidth=2;
    X.beginPath(); X.moveTo(mouth.x-20,mouth.y); X.lineTo(mouth.x+20,mouth.y); X.moveTo(mouth.x,mouth.y-20); X.lineTo(mouth.x,mouth.y+20); X.stroke(); X.restore();
  }
}

function loop(t){ if(!running) return; if(!paused){ const dt=Math.min(.033,(t-(loop.t||t))/1000); loop.t=t; step(dt); render(); } requestAnimationFrame(loop); }

/* Contr√¥les */
function start(){ reset(); running=true; paused=false; splash.style.display='none'; over.style.display='none'; loop.t=undefined; requestAnimationFrame(loop); }
function end(){ running=false; over.style.display='grid';
  const rank = score>=600?'Ma√Ætre de la ruche üèÜ': score>=400?'Apiculteur avis√© üêù': score>=250?'Butineur styl√© üåº':'Apprenti apiculteur üçØ';
  document.getElementById('final').textContent=`Score : ${score} ‚Ä¢ ${mult===2?'miel dor√© activ√©':'combo x1'}`;
  document.getElementById('badge').textContent=rank;
}

bPlay.onclick=start; bStart.onclick=start; bRestart.onclick=start;
bSmoke.onclick=()=>{smokeLeft=Math.max(smokeLeft,6); toast('üí® Tout doux les copines');};

let primed=true; addEventListener('pointerdown',()=>{ if(primed){primed=false; start();}}, {once:true,passive:true});

scoreEl.textContent=0; multiEl.textContent='x1';
})();
</script>
