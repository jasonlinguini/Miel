<script>
(()=>{ // ===== JEU PATCH ANTISPAM =====
  const C = document.getElementById('game');
  const X = C.getContext('2d');
  const splash = document.getElementById('splash');
  const over = document.getElementById('gameOver');
  const bStart=document.getElementById('startBtn'), bStart2=document.getElementById('startBtn2'), bRe=document.getElementById('restartBtn');
  const bPause=document.getElementById('pauseBtn'), bSmoke=document.getElementById('smokeBtn');
  const scoreEl=document.getElementById('score'), comboEl=document.getElementById('combo'), timeEl=document.getElementById('time');
  const toasts = document.getElementById('toasts');
  const flowers = document.getElementById('flowers');
  const quizEl = document.getElementById('quiz');
  const qTitle = document.getElementById('qTitle'), qText = document.getElementById('qText');
  const qA = document.getElementById('qA'), qB = document.getElementById('qB'), qC = document.getElementById('qC'), qRes = document.getElementById('qResult');

  // images
  const label = new Image(); label.src = "4A20A11D-FFE4-40F0-B5C8-41535E58C891.jpeg";

  // layout
  let W=1280,H=720;
  function rsz(){ const dpr=Math.min(devicePixelRatio||1,2); W=C.clientWidth; H=C.clientHeight;
    C.width=Math.floor(W*dpr); C.height=Math.floor(H*dpr); X.setTransform(dpr,0,0,dpr,0,0); }
  addEventListener('resize', rsz, {passive:true}); rsz();

  // inputs
  const ptr={x:W/2,y:H/2,last:0};
  function setPtr(e){ const b=C.getBoundingClientRect();
    if(e.touches && e.touches[0]){ ptr.x=e.touches[0].clientX-b.left; ptr.y=e.touches[0].clientY-b.top; }
    else if(e.clientX!=null){ ptr.x=e.clientX-b.left; ptr.y=e.clientY-b.top; } }
  C.addEventListener('mousemove', setPtr);
  C.addEventListener('touchstart', (e)=>{ setPtr(e); const n=performance.now(); if(n-ptr.last<300) puff(); ptr.last=n; }, {passive:true});
  C.addEventListener('touchmove', setPtr, {passive:true});

  // state
  let run=false, pause=false, t0=0, timer=90;
  let score=0, serie=0, serieTimer=0, golden=0, smoke=0;
  let ents=[], pot={x:W/2,y:H/2};
  const MAX_BEES=10, MAX_WASPS=1; // facile
  let nextFactAt = 8, nextQuizAt = 18;

  // facts & jokes
  const FACTS = [
    "Une abeille visite ~50 fleurs par trajet ðŸŒ¸",
    "La fumÃ©e masque lâ€™alarme : abeilles plus calmes.",
    "80% des plantes Ã  fleurs ont besoin des pollinisateurs.",
    "La reine pond jusquâ€™Ã  2â€™000 Å“ufs/jour ðŸ‘‘",
    "Plante des fleurs locales : nectar rÃ©gulier !",
  ];
  const JOKES = [
    "â€œJe peigne mes cheveux et mes ruches.â€ â€” David",
    "Tartine en Valais si +500 pts ðŸ˜‰",
    "GuÃªpe jalouse repÃ©rÃ©e.",
    "Buzzâ€¦iness as usual.",
    "Seumâ€¦ de pollen.",
  ];
  const QUIZZES = [
    {q:"Pourquoi la fumÃ©e ?", a:["Calmer les abeilles","Les faire danser","Cuire des crÃªpes"], ok:0,
     exp:"Elle masque les phÃ©romones dâ€™alarme et les fait se gaver de miel."},
    {q:"Le mieux au jardin :", a:["Fleurs Ã©talÃ©es toute lâ€™annÃ©e","Seulement lâ€™Ã©tÃ©","NoÃ«l"], ok:0,
     exp:"Des floraisons Ã©talÃ©es = nectar/pollen rÃ©guliers."},
    {q:"Qui pique ?", a:["OuvriÃ¨re","Reine","Faux-bourdon"], ok:0,
     exp:"Les ouvriÃ¨res dÃ©fendent la ruche. Le mÃ¢le nâ€™a pas de dard."}
  ];
  function randItem(a){ return a[Math.floor(Math.random()*a.length)] }

  // === Anti-spam toasts ===
  let lastToastAt = 0, lastToastMsg = "", activeToasts = 0;
  function toast(msg){
    const now = performance.now();
    if (activeToasts >= 2) return;                // max 2 visibles
    if (now - lastToastAt < 900 && msg===lastToastMsg) return; // dÃ©lai + pas de doublon immÃ©diat
    lastToastAt = now; lastToastMsg = msg;
    const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toasts.appendChild(d);
    activeToasts++;
    setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(-6px)'; }, 1100);
    setTimeout(()=>{ d.remove(); activeToasts=Math.max(0, activeToasts-1); }, 1500);
  }

  // petite pluie dâ€™emoji, cap Ã  1 par 2,5s
  let lastRainAt = 0;
  function emojiRain(){
    const now = performance.now(); if (now - lastRainAt < 2500) return; lastRainAt = now;
    const EMO=["ðŸŒ¼","ðŸŒ¸","ðŸŒ»","ðŸ","ðŸ¯"];
    for(let i=0;i<14;i++){ const f=document.createElement('div'); f.className='flower';
      f.textContent=randItem(EMO); f.style.left=Math.floor(Math.random()*100)+"vw";
      f.style.fontSize=(16+Math.random()*20)+"px"; f.style.animationDelay=(Math.random()*0.3)+"s";
      flowers.appendChild(f); setTimeout(()=>f.remove(),1700); }
  }

  function hud(){ comboEl.textContent=`x${golden>0?2:1} / sÃ©rie ${serie}${smoke>0?' â€¢ ðŸ’¨':''}`;
    scoreEl.textContent=score; timeEl.textContent=Math.ceil(timer); }

  function reset(){
    score=0; serie=0; serieTimer=0; golden=0; smoke=0; timer=90; ents=[];
    for(let i=0;i<MAX_BEES;i++) spawnBee(Math.random()<.12);
    for(let i=0;i<MAX_WASPS;i++) if(Math.random()<.5) spawnWasp();
    pot.x=W/2; pot.y=H/2; nextFactAt=8; nextQuizAt=18; hud();
  }

  function spawnBee(queen=false){
    const side=Math.floor(Math.random()*4), m=30;
    ents.push({t:queen?'Q':'B', x: side==0?-m : side==1?W+m : Math.random()*W,
               y: side==2?-m : side==3?H+m : Math.random()*H,
               vx:0, vy:0, spd:(.5+Math.random())*(queen?.85:1), r: queen?14:10, sw: Math.random()*6.28});
  }
  function spawnWasp(){
    ents.push({t:'W', x:Math.random()*W, y:Math.random()*H, vx:0, vy:0, spd:1.0+Math.random()*0.6, r:11, sw:Math.random()*6.28, hitCD:0});
  }

  function attract(ax,ay,bx,by,str){ let dx=ax-bx, dy=ay-by, d2=dx*dx+dy*dy, d=Math.sqrt(d2)||.0001;
    let f=Math.max(-.08,Math.min(.08,str/d2)); return {fx:dx/d*f, fy:dy/d*f, d}; }

  function drawJar(){
    const r=60; X.save(); X.translate(pot.x,pot.y);
    X.beginPath(); X.moveTo(-r*.6,-r*.6); X.quadraticCurveTo(-r*.9,r*.2,-r*.5,r*.9);
    X.quadraticCurveTo(0,r*1.2,r*.5,r*.9); X.quadraticCurveTo(r*.9,r*.2,r*.6,-r*.6); X.closePath();
    X.fillStyle='#2b2116'; X.fill(); X.lineWidth=2; X.strokeStyle='#6c512c'; X.stroke();
    X.drawImage(label,-43,-56,86,112);
    X.globalAlpha=.45; X.beginPath(); X.arc(0,10,70,0,Math.PI*2); X.fillStyle=golden>0?'#ffd777':'#c69a57'; X.fill(); X.globalAlpha=1;
    X.restore();
  }
  function drawBee(b){ X.save(); X.translate(b.x,b.y);
    X.beginPath(); X.fillStyle=b.t=='Q'?'#ffd777':'#e6c15e'; X.ellipse(0,0,b.r+2,b.r,0,0,Math.PI*2); X.fill();
    X.lineWidth=2; X.strokeStyle='#2b2116'; X.beginPath(); X.moveTo(-b.r,-2); X.lineTo(b.r,-2); X.moveTo(-b.r,2); X.lineTo(b.r,2); X.stroke();
    X.restore(); }
  function drawWasp(w){ X.save(); X.translate(w.x,w.y); X.beginPath(); X.fillStyle='#ff5858'; X.ellipse(0,0,w.r+2,w.r,0,0,Math.PI*2); X.fill(); X.restore(); }
  function grid(){ X.globalAlpha=.25; for(let i=0;i<W;i+=64){ X.beginPath(); X.moveTo(i,0); X.lineTo(i,H); X.strokeStyle='#251d14'; X.stroke(); }
    for(let j=0;j<H;j+=64){ X.beginPath(); X.moveTo(0,j); X.lineTo(W,j); X.strokeStyle='#251d14'; X.stroke(); } X.globalAlpha=1; }

  let goldenLockUntil = 0; // anti double miel dorÃ©

  function step(dt){
    // progress & events
    nextFactAt -= dt; nextQuizAt -= dt;
    if(nextFactAt<=0){ toast("â„¹ï¸ "+randItem(FACTS)); nextFactAt = 10+Math.random()*6; }
    if(nextQuizAt<=0){ openQuiz(); nextQuizAt = 24+Math.random()*8; }

    const ez=Math.min(1, dt*6); pot.x += (ptr.x-pot.x)*ez; pot.y += (ptr.y-pot.y)*ez;
    const AS=3400; // attraction forte (facile)
    for(let i=ents.length-1;i>=0;i--){
      const e=ents[i]; e.sw+=dt*(.4+Math.random()*.6); e.vx+=Math.cos(e.sw)*.04; e.vy+=Math.sin(e.sw)*.04;

      if(e.t!='W'){
        const sl=smoke>0?.6:1; const {fx,fy,d}=attract(pot.x,pot.y,e.x,e.y,AS*sl);
        e.vx+=fx; e.vy+=fy; const cap=2.1*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy;
        const CATCH=90; if(d<CATCH){
          const base=(e.t=='Q'?50:10), mult=(golden>0?2:1);
          score += base*mult; serie++; serieTimer=3.0;
          if(serie%3==0 && performance.now()>goldenLockUntil){ golden = 8; goldenLockUntil = performance.now()+500; toast("âœ¨ Miel dorÃ© : points x2 !"); emojiRain(); }
          if(Math.random()<.15) bubble(e.x,e.y, randItem(JOKES));
          ents.splice(i,1); spawnBee(Math.random()<.1); continue;
        }
      } else {
        // WASP with cooldown
        const sl=smoke>0?.5:1; const {fx,fy}=attract(e.x,e.y,pot.x,pot.y,3000*sl);
        e.vx+=fx; e.vy+=fy; const cap=2.2*e.spd*sl; e.vx=Math.max(-cap,Math.min(cap,e.vx)); e.vy=Math.max(-cap,Math.min(cap,e.vy));
        e.x+=e.vx; e.y+=e.vy;
        if(e.hitCD>0) e.hitCD -= dt;
        if(e.hitCD<=0 && Math.hypot(e.x-pot.x,e.y-pot.y)<58){
          score=Math.max(0,score-10); serie=0; serieTimer=0; e.hitCD = 0.8; toast("AÃ¯e ! GuÃªpe un peu susceptible ðŸ");
        }
      }
      // wrap
      if(e.x<-20)e.x=W+20; if(e.x>W+20)e.x=-20; if(e.y<-20)e.y=H+20; if(e.y>H+20)e.y=-20;
    }

    timer -= dt; if(timer<=0){ run=false; over.hidden=false; document.getElementById('endMsg').textContent=`Score : ${score}`; }
    if(serieTimer>0){ serieTimer -= dt; if(serieTimer<=0) serie=0; }
    if(golden>0) golden -= dt; if(smoke>0) smoke -= dt;
    hud();
  }

  function render(){ X.clearRect(0,0,W,H); grid(); for(const e of ents){ (e.t=='W') ? drawWasp(e) : drawBee(e); } drawJar(); }

  function loop(t){ if(!run) return; if(!pause){ const dt=Math.min(.033,(t-t0)/1000); t0=t; step(dt); render(); } requestAnimationFrame(loop); }

  function start(){ reset(); run=true; pause=false; t0=performance.now(); splash.hidden=true; over.hidden=true; requestAnimationFrame(loop); }
  function toggle(){ if(!run)return; pause=!pause; bPause.textContent = pause?'â–¶ï¸ Reprendre':'â¸ï¸ Pause'; }
  function puff(){ smoke = Math.max(smoke,6); toast("ðŸ’¨ â€œTout doux les copines.â€ â€” David"); }

  // dÃ©marrage au premier tap n'importe oÃ¹
  let armed=true; window.addEventListener('pointerdown',()=>{ if(armed){ armed=false; start(); } }, {once:true, passive:true});

  // boutons
  bStart.onclick=start; bStart2 && (bStart2.onclick=start); bRe && (bRe.onclick=start);
  bPause.onclick=toggle; bSmoke.onclick=puff;

  // ==== QUIZ ====
  let currentQuiz=null;
  function openQuiz(){
    if(!run) return;
    currentQuiz = randItem(QUIZZES);
    qTitle.textContent = "Quiz Ã©clair ðŸ +50 pts / +10s si juste";
    qText.textContent = currentQuiz.q; qRes.style.display='none';
    [qA,qB,qC].forEach((btn,i)=>{ btn.textContent = currentQuiz.a[i]; btn.disabled=false; btn.onclick=()=>answer(i); });
    quizEl.style.display='grid'; pause=true;
  }
  function answer(i){
    [qA,qB,qC].forEach(b=>b.disabled=true);
    const ok = (i===currentQuiz.ok);
    if(ok){ score += 50; timer += 10; toast("âœ… Bonne rÃ©ponse ! +50 pts +10s"); }
    else { toast("âŒ Oups â€” pas grave !"); }
    qRes.textContent = currentQuiz.exp; qRes.style.display='block';
    setTimeout(()=>{ quizEl.style.display='none'; pause=false; }, 1400);
  }

  // init
  splash.hidden=false; over.hidden=true; hud();
})();
</script>
