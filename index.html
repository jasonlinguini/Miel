<script>
(function(){
  // ‚Äî helpers
  const $=id=>document.getElementById(id);
  const errBox = $('err');

  // Toujours montrer les erreurs √† l‚Äô√©cran (√©vite la ‚Äúpage blanche‚Äù silencieuse)
  window.onerror = (msg, src, line) => {
    if (!errBox) return;
    errBox.style.display = 'block';
    errBox.textContent = (msg||'Erreur JS') + (line?(' @'+line):'');
  };

  // On attend que TOUT soit pr√™t (iOS aime bien‚Ä¶)
  window.addEventListener('load', init, {once:true});

  function init(){
    // √©l√©ments
    const cv=$('cv'), X=cv.getContext('2d');
    const splash=$('splash'), over=$('over');
    const bPlay=$('play'), bStart=$('start'), bAgain=$('again');
    const scoreEl=$('score'), comboEl=$('combo'), timeEl=$('time');

    // garde-fous : si un id manque, on l‚Äôaffiche en bas
    const miss=[cv,splash,over,bPlay,bStart,bAgain,scoreEl,comboEl,timeEl].some(x=>!x);
    if(miss){ window.onerror('Un √©l√©ment est introuvable (id cass√© ?)'); return; }

    // √©tat de jeu minimal (fiable)
    let running=false, timer=30, score=0, mult=1, rafId=0, t0=0;

    function hud(){ scoreEl.textContent=score; comboEl.textContent='x'+mult; timeEl.textContent=Math.ceil(timer); }

    function loop(t){
      const dt = Math.min(0.033, (t-(t0||t))/1000); t0=t;
      if (running){
        timer -= dt;
        if (timer<=0){ end(); return; }
        // rendu minimal (fond + texte pour v√©rifier que √ßa tourne)
        const w=cv.width=cv.clientWidth*window.devicePixelRatio;
        const h=cv.height=cv.clientHeight*window.devicePixelRatio;
        X.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
        X.clearRect(0,0,cv.clientWidth,cv.clientHeight);
        X.fillStyle='#0f0f0f'; X.fillRect(0,0,cv.clientWidth,cv.clientHeight);
        X.fillStyle='#d7b06a'; X.font='700 18px system-ui';
        X.fillText('üêù √áa buzz !', 14, 28);
        hud();
      }
      rafId=requestAnimationFrame(loop);
    }

    function start(){
      // reset
      running=true; timer=30; score=0; mult=1; hud();
      splash.style.display='none'; over.style.display='none';
      cancelAnimationFrame(rafId); t0=0; rafId=requestAnimationFrame(loop);
    }
    function end(){
      running=false;
      over.style.display='grid';
      $('final').textContent = `Score : ${score} ‚Ä¢ ${mult===2?'miel dor√©':'combo x1'}`;
    }

    // branchement **fiable** des boutons (double s√©curit√© : addEventListener + fallback onclick)
    bPlay.addEventListener('click', start);
    bStart.addEventListener('click', start);
    bAgain.addEventListener('click', start);
    bPlay.onclick = bStart.onclick = bAgain.onclick = start;

    // i18n boutons
    $('lang-fr')?.addEventListener('click', ()=>switchLang('fr'));
    $('lang-de')?.addEventListener('click', ()=>switchLang('de'));

    function switchLang(lang){
      // juste le minimum pour que les boutons restent utilisables
      const fr = (lang==='fr');
      document.getElementById('t-title').textContent = fr ? 'Attrape-Abeilles B√ºrchen üêùüçØ' : 'Bienenf√§nger B√ºrchen üêùüçØ';
      document.getElementById('t-sub').textContent   = fr ? 'Avec David (Coco), apiculteur en Valais ‚Äî partie 30s'
                                                           : 'Mit David (Coco), Imker im Wallis ‚Äî 30-Sekunden-Runde';
      document.getElementById('t-play').textContent  = fr ? 'Jouer' : 'Spielen';
      document.getElementById('t-start').textContent = fr ? 'Lancer' : 'Start';
      document.getElementById('t-end').textContent   = fr ? 'Fin de partie' : 'Spielende';
      document.getElementById('t-again').textContent = fr ? 'Rejouer' : 'Nochmal';
      document.getElementById('lang-fr')?.classList.toggle('active', fr);
      document.getElementById('lang-de')?.classList.toggle('active', !fr);
    }

    // HUD initial + d√©marrage de la boucle en attente
    hud(); requestAnimationFrame(loop);
  }
})();
</script>
